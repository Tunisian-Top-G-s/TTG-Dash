{% extends "base.html" %}
{% load static %}

{% block head %}
  <link rel="stylesheet" href="{% static "styles/checkout.css" %}">
  {% block title %}
    <title>Checkout - Tunisian Top Gs</title>
  {% endblock title %}
{% endblock head %}

{% block header %}
  {% include "components/navbar.html" %}
{% endblock header %}

{% block main %}
  <div class="shopping-cart">
    <div class="h1-text">Checkout</div>
    <div class="items-container">
      <div class="Title">
        Add Your Adresse
      </div>
      <form method="POST">
        {% csrf_token %}
        <div>
            <div class="input-container">
                <label for="id_first_name">First Name</label>
                <input type="text" id="id_first_name" name="first_name" />
            </div>
            <div class="input-container">
                <label for="id_last_name">Last Name</label>
                <input type="text" id="id_last_name" name="last_name" />
            </div>
        </div>
        <div class="input-container">
            <label for="id_address">Address</label>
            <input type="text" id="id_address" name="address" />
        </div>
        <div>
            <div class="input-container">
                <label for="id_city">City</label>
                <input type="text" id="id_city" name="city" />
            </div>
            <div class="input-container">
                <label for="id_state">State</label>
                <input type="text" id="id_state" name="state" />
            </div>
            <div class="input-container">
                <label for="id_zip_code">Zip Code</label>
                <input type="text" id="id_zip_code" name="zip_code" />
            </div>
        </div>
    </form>
    </div>

    <div class="delivery-container">
      <div class="Title">
        Choose Your Payment Method
      </div>
      <div class="payment-method">
        <div class="payment">
          <input type="radio" id="paypal" name="payment" value="paypal" />
          <label for="paypal">Cash On Delivery </label>
          <i data-lucide="truck"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="order">
    <div class="order-container">
      <div class="order-details">
        <span class="h1-text">Order Summary</span>
        <div class="price">
          <span class="p-text">Price</span>
          <span class="p-text">TND {{cart.price}}</span>
        </div>
        <div class="discount">
          <span class="p-text">Discount</span>
          <span class="p-text">TND 0</span>
        </div>
        <div class="shipping">
          <span class="p-text">Shipping</span>
          <span class="p-text greener">Free</span>
        </div>
        <div class="coupon">
          <span class="p-text">Coupon Applied</span>
          <span class="p-text">TND 0.00</span>
        </div>
      </div>
      <div class="divisier"></div>
      <div class="order-total">
        <div class="total">
          <span class="p-text">Total</span>
          <span class="p-text">TND {{cart.price}}</span>
        </div>
        <div class="delivery">
          <span class="p-text">Estimated Delivery by</span>
          <span class="p-text">01 Feb, 2024</span>
        </div>
        <a class="btn place-order-button" href="#">Place Order</a>

        <span class="place-order">By placing your order, you agree to our company Privacy policy and Conditions of use.</span>
      </div>
    </div>
  </div>
</main>
{% endblock main %}

{% block scripts %}
<script>
  const placeOrderButton = document.querySelector(".place-order-button");
  placeOrderButton.addEventListener("click", function (event) {
      event.preventDefault(); // Prevent the default action of anchor tag
      
      // Get the values of each input field
      const firstName = document.getElementById("id_first_name").value;
      const lastName = document.getElementById("id_last_name").value;
      const address = document.getElementById("id_address").value;
      const city = document.getElementById("id_city").value;
      const state = document.getElementById("id_state").value;
      const zipCode = document.getElementById("id_zip_code").value;
      
      // Add the selected payment method
      const paymentMethod = "credit-card";

      // Get the cart ID from your Django template variable
      const cartId = "{{ cartID }}";

      // AJAX request to create the order
      $.ajax({
          type: 'POST',
          url: '/create-order/',
          data: {
              "first_name": firstName,
              "last_name": lastName,
              "address": address,
              "city": city,
              "state": state,
              "zip_code": zipCode,
              "payment_method": paymentMethod,
              "cartId": cartId,
          },
          beforeSend: function(xhr, settings) {
              xhr.setRequestHeader('X-CSRFToken', getCookie("csrftoken"));
          }, 
          success: function (response) {
              console.log(response);
              window.location.href = response.url;
              // Handle success response
          },
          error: function (xhr, status, error) {
              console.error('Error:', error);
              // Handle error response
          }
      });
  });


  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock scripts %}