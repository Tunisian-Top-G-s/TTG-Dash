{% extends "base.html" %}
{% load static %}

{% block head %}
    <link rel="stylesheet" href="{% static "styles/cart.css" %}">
    {% block title %}
        <title>Cart - Tunisian Top Gs</title>
    {% endblock title %}
{% endblock head %}

{% block main %}
    {% include "components/navbar.html" %}
    <div class="cart-wrapper">
        <div class="shopping-cart">
            <div class="h1-text">Shopping Cart</div>
            <div class="items-container">
                <div class="empty-cart" id="emptyCart">
                    <!-- Empty cart message -->
                    <img src="{% static "assets/img/empty-cart.png" %}" alt="cart empty" />
                    <div class="empty-cart-container">
                        <span class="h1-text">Your cart is empty</span>
                        <a href="/shop" class="btn">Continue Shopping</a>
                    </div>
                </div>
                <div class="items-list" id="items-list">
                    {% for item in cart.cart_items.all %}
                        <div class="item-container">
                            <div class="item-description">
                                <img src="{{item.product.image.url}}" alt="product-img" />
                                <div class="item-recap">
                                    <span class="h1-text">{{item.product.title}}</span>
                                    <span class="item-size">size: <span class="p-text">{{item.size}}</span></span>
                                    <span class="item-color">color: <span class="p-text">{{item.color}}</span></span>
                                    <div class="item-price">
                                        <span class="h1-text">{{item.product.price}} DT</span>
                                    </div>
                                </div>
                            </div>
                            <button class="delete-icon" data-item-id="{{ item.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
                                </svg>
                            </button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="order">
            <div class="order-container">
                <div class="order-details">
                    <span class="h1-text">Order Summary</span>
                    <div class="price">
                        <span class="p-text">Price</span>
                        <span class="p-text subTotal">TND {{cart.calculate_total_price}}</span>
                    </div>
                    <div class="discount">
                        <span class="p-text">Discount</span>
                        <span class="p-text">$0</span>
                    </div>
                    {% comment %} <div class="shipping">
                        <span class="p-text">Shipping</span>
                        <span class="p-text greener shippingtotal">Free</span>
                    </div> {% endcomment %}
                    <div class="coupon">
                        <span class="p-text">Coupon Applied</span>
                        <span class="p-text">$0.00</span>
                    </div>
                </div>
                <div class="divisier"></div>
                <div class="order-total">
                    <div class="total">
                        <span class="p-text">Total</span>
                        <span class="p-text TTotal">TND {{cart.calculate_total_price}}</span>
                    </div>
                    {% comment %} <div class="delivery">
                        <span class="p-text">Estimated Delivery by</span>
                        <span class="p-text">âˆž</span>
                    </div> {% endcomment %}
                    <input placeholder="Coupon Code" />
                    <button class='cupon'>Get Coupon Code</button>
                    <a class="btn goCheckout checkoutbtn">Proceed to Checkout</a>
                </div>
            </div>
        </div>
    </div>
{% endblock main %}

{% block scripts %}
<script type='text/javascript'>
  document.addEventListener('DOMContentLoaded', function() {
      // Define variables
      const subTotalDiv = document.querySelector(".subTotal");
      const TotalDiv = document.querySelector('.TTotal');

      const deleteButtons = document.querySelectorAll('.delete-icon');
      const shippingTotalDiv = document.querySelector('.shippingtotal');
      let TotalPrice = {{cart.calculate_total_price}}
      let shippingCost = 0
      
      function reloadPrices(totalPrice, shippingMethod) {
          subTotalDiv.innerText = `TND ${totalPrice}`
          TotalDiv.innerText = `TND ${totalPrice + calculateShippingCost(shippingMethod)}`;
          TotalPrice = totalPrice
      }

      // Add event listeners to all delete buttons
      deleteButtons.forEach(button => {
          button.addEventListener('click', function () {
              const itemId = button.dataset.itemId; // Access dataset attribute of the button
  
              // Send a POST request to delete the cart item
              $.ajax({
                  type: 'POST',
                  url: '/delete-cart-item/',
                  data: { itemId: itemId }, // Pass the item ID in the request data
                  beforeSend: function (xhr, settings) {
                      xhr.setRequestHeader('X-CSRFToken', getCookie("csrftoken"));
                  },
                  success: function (response) {
                      console.log(response);
                      // Remove the cart item from the HTML on success
                      window.location.reload()
                  },
                  error: function (xhr, status, error) {
                      console.error('Error deleting cart item:', error);
                  }
              });
          });
      });

      // Event listener for checkout button
      const checkoutButton = document.querySelector('.checkoutbtn');
      checkoutButton.addEventListener('click', function(event) {
          event.preventDefault();
          console.log("Checkout button")
          //save price and shipping method to cart
            console.log("{{cart.price}}")
          $.ajax({
              type: 'POST',
              url: '/final-cart-checkout/',
              data: {cartId: {{cart.id}}, price: {{cart.price}} + 7, shippingMethod: 1, shippingCost: 7},
              beforeSend: function (xhr, settings) {
                  xhr.setRequestHeader('X-CSRFToken', getCookie("csrftoken"));
              },
              success: function (response) {
                  console.log(response)
              },
              error: function (xhr, status, error) {
                  console.error('Error deleting cart item:', error);
              }
          });

          window.location.href = `/checkout`;
      });
  
  
      // Function to get cookie value
      function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
  });
  </script>



{% endblock scripts %}
