{% extends "base.html" %}
{% load static %}

{% block head %}
{% block title %}<title>Chat | Tunisian Top Gs</title>{% endblock title %}
<link rel="stylesheet" href="{% static "styles/serverChat.css" %}">
{% endblock head %}

{% block header %}
    {% comment %} {% include "components/navbar.html" %} {% endcomment %}
{% endblock header %}

{% block main %}
{% include "components/navbar.html" %}
{{ room_name|json_script:"room-name" }}
{{ user_id|json_script:"user-id" }}
    <div class="chat-wrapper">
            <!-- _____________________________________________________ -->

        <div class="mobile-toggles-btn">
            <button class="toggle-chat-room-mobile" onclick="toggleRoomsMobile()">
                <i data-lucide="align-left"></i>
            </button>
            <button class="toggle-chat-members-mobile" onclick="toggleMembersMobile()">
                <i data-lucide="users"></i>
            </button>
            
        </div>
            <!-- _____________________________________________________ -->
           
            
        <div class="chat-rooms">
      
            

                <div class="toggle-left-bar">

            <div class="chat-rooms-header">
              
                <a href="/courses" class="to-courses">
                    <span>

                        <svg xmlns="http://www.w3.org/2000/svg" width="33" height="32" viewBox="0 0 33 32" fill="none">
                            <path
                                d="M4.1 22.5C3.1 20.5 2.5 18.3 2.5 16C2.5 8.3 8.8 2 16.5 2V4C9.9 4 4.5 9.4 4.5 16C4.5 18 5 19.8 5.9 21.5L4.1 22.5ZM28.5 16C28.5 22.6 23.1 28 16.5 28C13.6 28 10.9 27 8.8 25.2L14.5 19.5L13.1 18L6.6 24.5C6.2 24.9 6.2 25.5 6.6 25.9C9.2 28.5 12.8 30 16.5 30C24.2 30 30.5 23.7 30.5 16H28.5Z"
                                fill="#F5F5F5" />
                            <path
                                d="M18.5003 25C18.4003 25 18.2003 25 18.1003 24.9C17.8003 24.8 17.5003 24.5 17.5003 24.1L16.8003 19.1L18.8003 18.8L19.2003 22.1L21.4003 20.4V15C21.4003 14.7 21.5003 14.5 21.7003 14.3L24.9003 11.1C25.8003 10.2 26.4003 8.9 26.4003 7.6V6H24.9003C23.6003 6 22.3003 6.5 21.4003 7.5L18.2003 10.7C18.0003 10.9 17.8003 11 17.5003 11H12.0003L10.3003 13.2L13.6003 13.6L13.3003 15.6L8.30026 14.9C7.90026 14.9 7.60026 14.6 7.50026 14.3C7.40026 14 7.40026 13.6 7.60026 13.3L10.6003 9.3C10.9003 9.1 11.2003 9 11.5003 9H17.1003L20.1003 6C21.4003 4.7 23.2003 4 25.0003 4H26.5003C27.6003 4 28.5003 4.9 28.5003 6V7.5C28.5003 9.4 27.8003 11.1 26.5003 12.4L23.5003 15.4V21C23.5003 21.3 23.4003 21.6 23.1003 21.8L19.1003 24.8C18.9003 24.9 18.7003 25 18.5003 25Z"
                                fill="#F5F5F5" />
                        </svg>
                        courses
                    </span>
                </a>
            </div>
           
            <div class="text-channels">
                {% for section in sections %}
                
                    <div class="text-group">
                        <div class="text-channels-header">
                            <div>
                                <button class="toggle-button">
                                    <i data-lucide="chevron-up" class="arrow"></i>
                                </button>
                                🏅・{{section.name}} 𝗦𝗘𝗖𝗧𝗜𝗢𝗡
                            </div>
                            <button class="add-channel">
                                <i data-lucide="plus"></i>
                            </button>
                        </div>
                        <ul class="channels-list">
                            {% for room in section.rooms.all %}
                                <li class="channel-link" data-room="{{room.name}}">
                                    <i data-lucide="hash"></i> 🌠・{{room.name}}
                                </li>
                            {% endfor %}
            <!-- _____________________________________________________ -->

                            {% comment %}                        
                        <li class="channel-link" data-room="students">
                                                    <i data-lucide="hash"></i> 💭・𝗦𝘁𝘂𝗱𝗲𝗻𝘁-𝗖𝗵𝗮𝘁

                                                </li>
                                                <li class="channel-link" data-room="crypto_wins">
                                                    <i data-lucide="hash"></i> 🏆・𝗖𝗿𝘆𝗽𝘁𝗼-𝘄𝗶𝗻𝘀
                                                </li>
                                                <li class="channel-link" data-room="students_anouncements">
                                                    <i data-lucide="hash"></i> 📢・𝗦𝘁𝘂𝗱𝗲𝗻𝘁𝘀-𝗔𝗻𝗻𝗼𝘂𝗻𝗰𝗲𝗺𝗲𝗻𝘁𝘀
                                                </li> {% endcomment %}
                        </ul>
                    </div>
                {% endfor %}
            <!-- _____________________________________________________ -->

                {% comment %} <div class="text-group">
                    <div class="text-channels-header">
                        <div>
                            <button class="toggle-button">
                                <i data-lucide="chevron-up" class="arrow"></i>
                            </button>
                            🌌・Signals
                        </div>
                        <button class="add-channel">
                            <i data-lucide="plus"></i>
                        </button>
                    </div>
                    <ul class="channels-list">
                        <li class="channel-link active" data-room="forex_signals">
                            <i data-lucide="hash"></i> 🌌・Forex Signals</li>
                        <li class="channel-link" data-room="crypto_signals">
                            <i data-lucide="hash"></i> 🌌・Crypto Signals</li>
                        <li class="channel-link" data-room="badges">
                            <i data-lucide="hash"></i> 📕・Get your Badges</li>
                    </ul>
                </div> {% endcomment %}
            </div>
           
            <div class="rooms-footer">
                <div class="change-status hidden">
                    <div class="status online">
                        <span class="status-online"></span>
                        <span class="status-text">Online</span>
                    </div>
                    <div class="status away">
                        <span class="status-away"></span>
                        <span class="status-text">Away</span>
                    </div>
                    <div class="status busy">
                        <span class="status-busy"></span>
                        <span class="status-text">Do Not Disturb</span>
                    </div>
                </div>
                <div class="user-profile">
                    <div class="user-container">
                        <div class="user-pic">
                            <img src="{{user.customuser.pfp.url}}" alt="user-pic">
                            <span class="user-status"></span>
                        </div>
                        <div class="user-info">
                            <span class="user-name">{{user.username}}</span>
                            <span class="user-status-text">Available</span>
                        </div>
                    </div>
                    <button class="change-status-btn">
                        <i data-lucide="chevron-up"></i>
                    </button>
                </div>
            </div>
        </div>
            <!-- _____________________________________________________ -->

        </div>
            <!-- _____________________________________________________ -->

        <div class="chat-container">
           
            <!-- _____________________________________________________ -->
            <div class="chat-header">
                <div class="chat-title">
                    <button id="chatRoomsToggle" class="chat-toggle-btn">
                        <svg id="icon-visible" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        <svg id="icon-hidden" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off">
                            <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/>
                            <path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/>
                            <path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/>
                            <line x1="2" x2="22" y1="2" y2="22"/>
                        </svg>
                    </button>
                    <span class="chat-title-channel-group">
                        <i data-lucide="hash"></i>
                         Text Channel
                    </span>
                    <span class="chat-title-room">🌠・{{room.name}}</span>

                </div>
                <div class="SearchMember-input">
                    <input type="text" id="userInput-search" placeholder="Search">
                    <button class="send-message">
                        <i data-lucide="send"></i>
                    </button>
                    
                </div>
                <button id="toggleButton" data-visible="true">
                    <svg id="icon-visible" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    <svg id="icon-hidden" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off">
                        <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/>
                        <path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/>
                        <path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/>
                        <line x1="2" x2="22" y1="2" y2="22"/>
                    </svg>
                </button>
            </div>
            <!-- _____________________________________________________ -->
            <!-- _____________________________________________________ -->
            <!-- _____________________________________________________ -->

            <div class="chat-box" id="chatBox">
              {% comment %}          
                 <div class="chat-message">
                    <div class="message-header">
                        <div class="user-pic">
                            <img src="{% static "assets/userpic.svg" %}" alt="user-pic">
                        </div>
                    </div>
                    <div class="message-content">
                        <div class="user-info">
                            <span class="user-name">Figgy</span>
                            <span class="message-date">Today</span>
                            <span class="message-time">2:30 PM</span>
                        </div>
                        <div class="message-text">
                            If you have any questions don't hesitate to reach out to a @deleted-role. They can be
                            reached at any time, Fusce porta elementum ligula hendrerit auctor. Suspendisse est ex,
                            egestas in pulvinar ut, facilisis quis velit. Vestibulum ullamcorper libero nulla, et
                            posuere odio eleifend eu. Ut feugiat lorem ac purus venenatis elementum. Mauris vestibulum
                            nibh ac turpis luctus venenatis non ut elit. Nulla venenatis, nulla quis ornare mollis, erat
                            ipsum ullamcorper ligula, sit amet blandit ipsum nisi elementum turpis. In vel blandit
                            ipsum.x
                        </div>
                        <div class="reactions-box">
                            <div class="react">
                                <div class="emoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><defs><style>.e{fill:#009345}</style></defs><rect x="1" y="1" width="22" height="22" rx="7.656" style="fill:#f8de40"/><path d="M23 13.938a14.69 14.69 0 0 1-12.406 6.531c-5.542 0-6.563-1-9.142-2.529A7.66 7.66 0 0 0 8.656 23h6.688A7.656 7.656 0 0 0 23 15.344z" style="fill:#e7c930"/><path d="M16.666 12.583H7.334a.493.493 0 0 0-.492.544c.123 1.175.875 3.842 5.158 3.842s5.035-2.667 5.158-3.842a.493.493 0 0 0-.492-.544z" style="fill:#864e20"/><path d="M12 16.969a6.538 6.538 0 0 0 2.959-.6 1.979 1.979 0 0 0-1.209-.853c-1.344-.3-1.75.109-1.75.109s-.406-.406-1.75-.109a1.979 1.979 0 0 0-1.209.853 6.538 6.538 0 0 0 2.959.6z" style="fill:#f06880"/><path class="e" d="M8.82 8.767a1.18 1.18 0 0 0-.378-.414 1.946 1.946 0 0 0-.536-.253 4.37 4.37 0 0 0-.444-.1.094.094 0 0 1-.079-.09V6.692a.1.1 0 0 1 .036-.074.081.081 0 0 1 .069-.018.882.882 0 0 1 .375.173.579.579 0 0 1 .189.385.344.344 0 0 0 .337.3H8.5a.342.342 0 0 0 .256-.116.336.336 0 0 0 .084-.262 1.536 1.536 0 0 0-.1-.407 1.22 1.22 0 0 0-.34-.465 1.457 1.457 0 0 0-.5-.273 2.3 2.3 0 0 0-.44-.092.09.09 0 0 1-.077-.089v-.246a.341.341 0 0 0-.682 0v.248a.094.094 0 0 1-.086.091 1.848 1.848 0 0 0-.975.381 1.251 1.251 0 0 0-.415 1.024 1.365 1.365 0 0 0 .146.624 1.185 1.185 0 0 0 .364.409 1.711 1.711 0 0 0 .506.238c.123.036.253.069.385.1a.091.091 0 0 1 .075.088v1.233a.092.092 0 0 1-.034.072.088.088 0 0 1-.073.019 1.089 1.089 0 0 1-.45-.189.575.575 0 0 1-.209-.39.339.339 0 0 0-.335-.293h-.118a.342.342 0 0 0-.34.383 1.254 1.254 0 0 0 .426.853 1.934 1.934 0 0 0 1.056.385.092.092 0 0 1 .077.093v.234a.341.341 0 0 0 .682 0v-.246a.094.094 0 0 1 .088-.091 2.069 2.069 0 0 0 1.02-.358 1.208 1.208 0 0 0 .467-1.03 1.29 1.29 0 0 0-.138-.619zm-.659.611a.663.663 0 0 1-.064.306.515.515 0 0 1-.175.2.941.941 0 0 1-.287.125c-.048.013-.1.023-.148.032a.084.084 0 0 1-.07-.019.1.1 0 0 1-.034-.072V8.855a.091.091 0 0 1 .034-.07.093.093 0 0 1 .059-.021h.02l.125.028a1.062 1.062 0 0 1 .295.116.512.512 0 0 1 .181.18.577.577 0 0 1 .064.29zM6.7 6.686v1.192a2.469 2.469 0 0 1-.192-.044.9.9 0 0 1-.259-.115.479.479 0 0 1-.162-.178.651.651 0 0 1-.058-.3.556.556 0 0 1 .2-.49 1.026 1.026 0 0 1 .363-.151h.02a.087.087 0 0 1 .053.019.1.1 0 0 1 .035.067zM18.723 8.767a1.18 1.18 0 0 0-.378-.414 1.946 1.946 0 0 0-.536-.249A4.37 4.37 0 0 0 17.365 8a.093.093 0 0 1-.078-.09V6.692a.093.093 0 0 1 .036-.074.078.078 0 0 1 .068-.017.892.892 0 0 1 .376.173.582.582 0 0 1 .188.385.345.345 0 0 0 .337.3h.108a.342.342 0 0 0 .256-.116.335.335 0 0 0 .084-.262 1.536 1.536 0 0 0-.1-.407 1.22 1.22 0 0 0-.332-.463 1.457 1.457 0 0 0-.5-.273 2.3 2.3 0 0 0-.44-.092.089.089 0 0 1-.076-.089v-.249a.342.342 0 0 0-.683 0v.248a.094.094 0 0 1-.086.091 1.848 1.848 0 0 0-.975.381 1.253 1.253 0 0 0-.415 1.024 1.368 1.368 0 0 0 .146.624 1.185 1.185 0 0 0 .364.409 1.711 1.711 0 0 0 .506.238c.123.036.253.069.385.1a.091.091 0 0 1 .075.088v1.233a.092.092 0 0 1-.034.072.088.088 0 0 1-.073.019 1.089 1.089 0 0 1-.45-.189.579.579 0 0 1-.209-.39.338.338 0 0 0-.336-.293h-.117a.342.342 0 0 0-.34.383 1.258 1.258 0 0 0 .426.853 1.934 1.934 0 0 0 1.056.385.092.092 0 0 1 .077.093v.234a.342.342 0 0 0 .683 0v-.246a.093.093 0 0 1 .087-.091 2.066 2.066 0 0 0 1.02-.358 1.208 1.208 0 0 0 .467-1.03 1.29 1.29 0 0 0-.143-.619zm-.659.611a.663.663 0 0 1-.064.306.515.515 0 0 1-.175.2.93.93 0 0 1-.287.125c-.048.012-.1.023-.147.032a.086.086 0 0 1-.071-.019.094.094 0 0 1-.033-.072V8.855a.091.091 0 0 1 .033-.07.093.093 0 0 1 .059-.021h.02l.125.028a1.05 1.05 0 0 1 .295.116.5.5 0 0 1 .181.182.566.566 0 0 1 .064.288zM16.6 6.686v1.192a2.469 2.469 0 0 1-.192-.044.89.89 0 0 1-.258-.115.463.463 0 0 1-.162-.178.637.637 0 0 1-.059-.3.559.559 0 0 1 .2-.49A1.026 1.026 0 0 1 16.5 6.6h.02a.087.087 0 0 1 .053.019.1.1 0 0 1 .027.067z"/></svg></div>
                                <div class="count">5</div>
                            </div>
                        </div>
                    </div>
                    <div class="reply-react">
                        <button class="reply" onclick="sendReplyMessage()">
                            <i data-lucide="reply"></i>
                        </button>
                        <div class="react">
                            <i data-lucide="smile"></i>
                        </div>
                    </div>
                </div>
                <div class="reply-message">
                    <div class="message-replied">
                        <svg xmlns="http://www.w3.org/2000/svg" width="46" height="16" viewBox="0 0 46 16" fill="none">
                            <path d="M1 15V15C1 7.26801 7.26801 1 15 1H45" stroke="#ADABAB" stroke-width="2"
                                stroke-linecap="round" />
                        </svg>
                        <div class="user-pic">
                            <img src="{% static "assets/userpic.svg" %}" alt="user-pic">
                        </div>
                        <div class="user-tag">
                            @Figgy
                        </div>
                        <span>
                            If you have any questions
                        </span>
                    </div>
                    <div class="chat-message">
                        <div class="message-header">
                            <div class="user-pic">
                                <img src="{% static "assets/userpic.svg" %}" alt="user-pic">
                            </div>
                        </div>
                        <div class="message-content">
                            <div class="user-info">
                                <span class="user-name">Figgy</span>
                                <span class="message-date">Today</span>
                                <span class="message-time">2:30 PM</span>
                            </div>
                            <span>
                                If you have any questions don't hesitate to reach out to a @deleted-role. They can be
                                reached at any time, Fusce porta elementum ligula hendrerit auctor. Suspendisse est ex,
                                egestas in pulvinar ut, facilisis quis velit. Vestibulum ullamcorper libero nulla, et
                                posuere odio eleifend eu. Ut feugiat lorem ac purus venenatis elementum. Mauris vestibulum
                                nibh ac turpis luctus venenatis non ut elit. Nulla venenatis, nulla quis ornare mollis, erat
                                ipsum ullamcorper ligula, sit amet blandit ipsum nisi elementum turpis. In vel blandit
                                ipsum.x
                            </span>
                        </div>
                        <div class="reply-react">
                            <button class="reply" onclick="replyToMessage()">
                                <i data-lucide="reply"></i>
                            </button>
                            <div class="react">
                                <i data-lucide="smile"></i>
                            </div>
                        </div>
                    </div>
                </div> 
                
                {% endcomment %}
            <!-- _____________________________________________________ -->

            </div>
            <!-- _____________________________________________________ -->
            <!-- _____________________________________________________ -->

            <div class="chat-footer-box">
                <div class="replying-to" style="display: none;">
                    <span>Replying to:</span>
                    <div class="message-replied"></div>
                    <button class="close" onclick="closeReplyMessage()">
                        <i data-lucide="x-circle"></i>
                    </button>
                </div>

            <!-- _____________________________________________________ -->

                <div class="chat-input">        
                        <!-- _____________________________________________________ -->
                        
                        
                        <!-- Hidden file input -->
                        
                     <!-- Hidden file input -->
                        <input id="chat-file-input" type="file" style="display: none;">

                        <!-- Visible pseudo-button that triggers the file input -->
                        <label for="chat-file-input" style="cursor: pointer;" class="upload-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus-circle">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                <line x1="8" y1="12" x2="16" y2="12"></line>
                            </svg>
                        </label>

                        <div id="file-preview-container" style="display:none;
                            position: absolute;
    top: 62vh;
    left: 5vh;">
                            <img id="file-preview" src="" alt="Preview" style="max-width: 200px;">
                        </div>
                        
                        <!-- _____________________________________________________ -->            
                        <!-- Textarea for typing messages -->

                        <!-- Old textarea -->
                        <div class="selected-gifs-container" style="    
                        height: 100px;
                       
                        white-space: nowrap;
                        display: flex;
                        justify-content: center;"></div>
                        <textarea class="chat-message-input" id="userInput" placeholder="Message # 💭・Badges Room "></textarea>


                        <!-- New contenteditable div -->
                        <!-- <div class="chat-message-input" contenteditable="true" id="userInput" placeholder="Message # 💭・Badges Room " ></div> -->

                        <!-- _____________________________________________________ -->

                    <div class="buttons-group">
                        <!-- Button for emoji picker -->
                        <div class="align-emojis">
                        <button  class="emoji-button" onclick="toggleEmojiPicker()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="1.7142857142857142" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-smile">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                <line x1="9" x2="9.01" y1="9" y2="9"/>
                                <line x1="15" x2="15.01" y1="9" y2="9"/>
                            </svg>
                        </button>
                        <div id="emoji-picker" style="
                        display:none; 
                        position: absolute;
                        bottom: 50px;
                        left: -63vh;
                        width: 72vh;
                        justify-content: center;
                        align-items: center;
                        transition: all 0.5s ease-in-out 0s;
                        animation: 0s linear 0.5s 1 normal forwards running appear;
                        transform: translateY(-20px);
                        -webkit-animation: slide-in-blurred-top 0.6s cubic-bezier(0.230, 1.000, 0.320, 1.000) both;
	                    animation: slide-in-blurred-top 0.6s cubic-bezier(0.230, 1.000, 0.320, 1.000) both;
                        "
                        >

                            
                        </div>
                    </div>
                        <!-- Button to toggle the GIF picker -->
                        <button id="toggleGifPicker" class="gif-picker-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-play"><path d="m11 16-5 5"/><path d="M11 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v6.5"/><path d="M15.765 22a.5.5 0 0 1-.765-.424V13.38a.5.5 0 0 1 .765-.424l5.878 3.674a1 1 0 0 1 0 1.696z"/><circle cx="9" cy="9" r="2"/></svg>
                        </button>

                        <!-- Container for GIF picker -->
                        <div id="gif-picker" class="gif-picker" style="display:none;">
                           
                        </div>

                        <!-- Button to submit message -->
                        <button class="chat-message-submit" class="send-message">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="1.7142857142857142" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                        </button>
                    </div>
                    <!-- _____________________________________________________ -->
                    <!-- Emoji picker -->
                    <!-- _____________________________________________________ -->  


                </div>
                <!-- _____________________________________________________ -->      
            </div>
        </div>

        <!-- _____________________________________________________ -->
        
       
       
        <div class="chat-members">
            
            <div class="toggle-member">

            <div class="chat-members-header">
                <i data-lucide="x" class="close-toggle"></i>
                <div>
                    <i data-lucide="users"></i>
                    MEMBERS
                </div>
                <span class="Members-counter">{{online_members.count}} online members</span>
            </div>
            <!-- _____________________________________________________ -->
            <div class="chat-members-body">
                

                <div class="memebers-list">

                    {% for badge in all_badges %}
                        <div class="members-titel">
                            <img src="{{badge.icon.url}}" alt="Members Badge">
                            <span>Members - <span class="counter">{{badge.customusers.count}}</span></span>
                        </div>
                        <ul class="users-list">
                                {% for member in badge.customusers.all %}
                                    {% if member in online_members %}
                                        <li class="user">
                                            <div class="user-pic">
                                                <img src="{{member.pfp.url}}" alt="user-pic">
                                                <span class="user-status"></span>
                                            </div>                                
                                            <span class="user-name">{{member.user.username}}</span>
                                        </li>
                                    {% endif %}
                                    {% if member in offline_members %}
                                        <li class="user">
                                            <div class="user-pic">
                                                <img src="{{member.pfp.url}}" alt="user-pic">
                                                <span class="user-status-offline"></span>
                                                
                                            </div>                                
                                            <span class="user-name">{{member.user.username}}</span>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                        </ul>
                    {% endfor %}
                    
                </div>
            </div>
        </div>
            <!-- _____________________________________________________ -->
        </div>

            <!-- _____________________________________________________ -->

    </div>

    {% endblock main %}
    
    {% block footer %}{% endblock footer %}

    {% block scripts %}


    <!-- <script src="{% static 'js/serverChat.js' %}"></script> -->

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
                        const changeStatusButtons = document.querySelectorAll('.change-status .status');
                        const userProfile = document.querySelector('.user-profile');
                        const changeStatusSection = document.querySelector('.change-status');
                        const toggleButtonIcon = document.querySelector('.change-status-btn svg');
                    
                        // Toggle change-status section visibility when button is clicked
                        document.querySelector('.change-status-btn').addEventListener('click', function() {
                            changeStatusSection.classList.toggle('hidden');
                            toggleButtonIcon.innerHTML = changeStatusSection.classList.contains('hidden') ?
                                `<path d="m6 9 6 6 6-6"></path>` :
                                `<path d="m6 15 6-6 6 6"></path>`;
                        });
                    
                        // Add click event listener to each change status button
                        changeStatusButtons.forEach(function(button) {
                            button.addEventListener('click', function() {
                                const status = button.classList[1]; // Get the second class which represents the status
                                updateStatus(status);
                                changeStatusSection.classList.add('hidden'); // Hide change-status section after selecting a status
                                toggleButtonIcon.innerHTML = `<path d="m6 9 6 6 6-6"></path>`;
                            });
                        });
                    
                        function updateStatus(status) {
                            const userStatus = userProfile.querySelector('.user-status-text');
                            const userStatusIcon = userProfile.querySelector('.user-status');
                    
                            // Update user status and status text
                            userStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1); // Capitalize first letter
                    
                            // Set background color based on status
                            if (status === 'online') {
                                userStatusIcon.style.backgroundColor = '#4CAF50'; // Green for Online
                            } else if (status === 'away') {
                                userStatusIcon.style.backgroundColor = '#FFC107'; // Yellow for Away
                            } else if (status === 'busy') {
                                userStatusIcon.style.backgroundColor = '#FF5722'; // Orange for Busy
                            }
                        }
                    
                        const changeStatusToggleButton = document.querySelector('.change-status-btn');
                    
                        // Add click event listener to the toggle button
                        changeStatusToggleButton.addEventListener('click', function() {
                            changeStatusSection.classList.toggle('visible');
                        });


                        // ----------------------------------------------
                        // Select all toggle buttons from room list
                        // ----------------------------------------------
                                        
                            const toggleButtons = document.querySelectorAll('.toggle-button');
                            const roomName = JSON.parse(document.getElementById('room-name').textContent);
                        
                            // Add click event listener to each toggle button
                            toggleButtons.forEach(function(toggleButton) {
                                toggleButton.addEventListener('click', function() {
                                    const parentGroup = toggleButton.closest('.text-group');
                                    const channelsList = parentGroup.querySelector('.channels-list');
                                    const toggleButtonIcon = toggleButton.querySelector('svg');
                        
                                    // Toggle channels visibility
                                    channelsList.classList.toggle('hidden');
                                    if (channelsList.classList.contains('hidden')) {
                                        toggleButtonIcon.innerHTML = `<path d="m6 9 6 6 6-6"></path>`;
                                    } else {
                                        toggleButtonIcon.innerHTML = `<path d="m6 15 6-6 6 6"></path>`;
                                    }
                                });
                            });
        
                        // ----------------------------------------------
                        // Select all channel links and add click event
                        // ----------------------------------------------

                            document.querySelectorAll('.channel-link').forEach(link => {
                                link.addEventListener('click', function(e) {
                                    e.preventDefault(); // Prevent default link action
                                    const roomName = this.getAttribute('data-room');
                                    const roomNameDisplay = document.querySelector('.chat-title-room');
                                    window.location.pathname = '/server-chat/' + roomName + '/';
                                    //console.log('Room clicked:', roomName);
                                    
                                    //updateChatMessages(roomName);
                                });
                            });
                       
                            // const channelLinks = document.querySelectorAll('.channel-link');
                        // console.log('Channel links found:', channelLinks.length); // Debugging output

                        // channelLinks.forEach(link => {
                        //     link.addEventListener('click', function(e) {
                        //       //e.preventDefault(); // Stop the link from causing a page reload
                        //         const roomName = this.getAttribute('data-room');
                        //         console.log('Room clicked:', roomName); // This should show the room name in the console

                        //         // Find the room name display element and update it
                        //         const roomNameDisplay = document.querySelector('.chat-title-room');
                        //         if (roomNameDisplay) {
                        //             roomNameDisplay.textContent = `🌠・${roomName}`; // Update the display
                        //         } else {
                        //             console.log('Failed to find the room name display element.');
                        //         }
                        //     });
                        // });
                       
                        // ----------------------------------------------
                        //Socket connection for chat messages 
                        // ----------------------------------------------

                        //const customuser_id = {{ customuser_id }};
                        //const roomName = JSON.parse(document.getElementById('room-name').textContent);
                        const messages = JSON.parse('{{ messages_json|escapejs }}');
                        const chatSocket = new WebSocket(
                            'ws://'
                            + window.location.host
                            + '/ws/chat/'
                            + roomName
                            + '/'
                        );
                        

                        // --------------------------------------------------
                        // displayOldMessages function - Display old messages
                        // --------------------------------------------------
                        function displayOldMessages(messages) {
                            const chatLog = document.querySelector('#chatBox');
                            chatLog.innerHTML = ''; // Clear existing messages
                            
                            const timestamp = new Date().toLocaleTimeString();
                            
                            if (Array.isArray(messages) && messages.length > 0) {
                                messages.forEach(message => {
                                    let fileContent = '';
                                    // Checking if there's a file attribute and it's not empty
                                    if (message.file) {
                                        //console.log("Image data received:", message.file); // Log the data for debugging
                                        fileContent = `<img src="/media/${message.file}" alt="Uploaded image" style="max-width: 200px;">`;
                                    } else {
                                       // console.log("No image data received.");
                                    }
                        
                                    const messageElement = document.createElement('div');
                                    messageElement.classList.add('chat-message');     
                                    messageElement.innerHTML = `
                                        <div class="message-header">
                                            <div class="user-pic">
                                                <img src="/media/${message.user__pfp}" alt="user-pic"> 
                                            </div>
                                        </div>
                                        <div class="message-content">
                                            <div class="user-info">
                                                <span class="user-name">${message.user__user__username}</span>
                                                <span class="message-date">${message.timestamp}</span>
                                            </div>
                                            <div class="message-text">${message.content}</div>
                                            <div class="image-user-upload">
                                            ${fileContent} <!-- Image displayed here if available -->
                                            </div>
                                            <div class="reactions-box">
                                                <div class="react">
                                                    <div class="emoji">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                                                    </div>
                                                    <div class="count">0</div> <!-- Static reaction count -->
                                                </div>
                                            </div>
                                        </div>
                                        <div class="reply-react">
                                            <button class="reply" onclick="sendReplyMessage()">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-reply">
                                                    <polyline points="9 17 4 12 9 7"/>
                                                    <path d="M20 18v-2a4 4 0 0 0-4-4H4"/>
                                                </svg>
                                            </button>
                                        </div>
                                    `;
                                    chatLog.appendChild(messageElement);
                                    chatLog.scrollTop = chatLog.scrollHeight; // Scroll to the bottom
                                });
                            } else {
                              //console.log('No old messages for this room.');
                              // console.log('Messages:', messages);
                              
                            }
                        }
                        
                        displayOldMessages(messages);

                        //----------------------------------------------
                        // Function to handle displaying messages
                        //----------------------------------------------

                        function displayMessage(data) {
                            const chatLog = document.querySelector('#chatBox');
                            const messageElement = document.createElement('div');
                            messageElement.classList.add('chat-message');
                        
                            const timestamp = new Date().toLocaleTimeString();
                            let content = data.message || '';
                        
                            // Check and embed YouTube videos or make URLs clickable
                            content = linkify(content);
                        
                            const fileContent = data.file ? `<img src="${data.file}" alt="Uploaded file" style="max-width: 200px;">` : '';
                            const gifContent = data.gif ? `<img src="${data.gif}" alt="GIF" style="max-width: 200px;">` : '';
                        
                            messageElement.innerHTML = `
                                <div class="message-header">
                                    <div class="user-pic">
                                        <img src="${data.pfp || '/default-user.png'}" alt="user-pic">
                                    </div>
                                </div>
                                <div class="message-content">
                                    <div class="user-info">
                                        <span class="user-name">${data.username}</span>
                                        <span class="message-date">${timestamp}</span>
                                    </div>
                                    <div class="message-text">${content}</div>
                                    ${fileContent}
                                    ${gifContent}
                                </div>
                            `;
                            chatLog.appendChild(messageElement);
                            chatLog.scrollTop = chatLog.scrollHeight;
                        }
                        
                        

                            //----------------------------------------------
                            // Listener for changes to the file input
                            //----------------------------------------------
                            document.querySelector('#chat-file-input').addEventListener('change', function() {
                                const filePreview = document.querySelector('#file-preview');
                                const fileContainer = document.querySelector('#file-preview-container');
                                if (this.files.length > 0) {
                                    const reader = new FileReader();
                                    reader.onload = function(evt) {
                                        filePreview.src = evt.target.result;
                                        fileContainer.style.display = 'block';
                                    };
                                    reader.readAsDataURL(this.files[0]);
                                } else {
                                    fileContainer.style.display = 'none';
                                }
                            });
                                
                       

                        //----------------------------------------------
                        // Event listener for the send button
                        //----------------------------------------------
                        document.querySelector('.chat-message-submit').addEventListener('click', function() {
                            const messageInput = document.querySelector('.chat-message-input');
                            const fileInput = document.querySelector('#chat-file-input');
                            const gifs = document.querySelectorAll('.selected-gifs-container img');
                            const message = messageInput.value.trim();
                            const file = fileInput.files[0];
                            const gifUrls = Array.from(gifs).map(img => img.src);
                        
                            console.log('Username:', username); // Ensure username is logged correctly
                            if (!message && gifUrls.length === 0 && !file) {
                                console.error('No message, GIF, or file selected.');
                                return;
                            }
                        
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = function(evt) {
                                    console.log('File ready for sending:', evt.target.result);
                                    sendToServer({
                                        username: username,
                                        message: message,
                                        file: evt.target.result,
                                        filename: file.name,
                                        gif: gifUrls.length > 0 ? gifUrls[0] : null
                                    });
                                    clearInputs();
                                };
                                reader.onerror = function(error) {
                                    console.error('Error reading file:', error);
                                };
                                reader.readAsDataURL(file);
                            } else {
                                sendToServer({
                                    username: username,
                                    message: message,
                                    gif: gifUrls.length > 0 ? gifUrls[0] : null
                                });
                                clearInputs();
                            }
                        });
                        

                        //----------------------------------------------
                        // Function to clear the chat message input and file input
                        //----------------------------------------------
                            function clearInputs() {
                                document.querySelector('.chat-message-input').value = '';
                                document.querySelector('#chat-file-input').value = '';
                                document.querySelector('.selected-gifs-container').innerHTML = '';
                            }
                        
                        //----------------------------------------------
                        // Function to send data to the WebSocket
                        //----------------------------------------------
                        function sendToServer(data) {
                            console.log("Attempting to send data to WebSocket: ", data);
                            chatSocket.send(JSON.stringify(data));
                        }

                        //----------------------------------------------
                        // On Enter key press, submit message
                        //----------------------------------------------
                        document.querySelector('.chat-message-input').addEventListener('keypress', function(e) {
                            if (e.key === 'Enter' && !e.shiftKey) {
                                e.preventDefault();
                                document.querySelector('.chat-message-submit').click();
                            }
                        });

                        //----------------------------------------------
                        //ChatSocket Event Listeners - onmessage, onerror, onopen, onclose
                        //----------------------------------------------
                            chatSocket.onmessage = function(e) {
                                const data = JSON.parse(e.data);
                                displayMessage(data);
                            };

                            chatSocket.onerror = function(error) {
                                console.error("WebSocket error:", error);
                            };

                            chatSocket.onopen = function() {
                                console.log("Connected to WebSocket server.");
                            };

                            chatSocket.onclose = function(e) {
                                console.log("WebSocket connection closed", e);
                            };
                        
     
                     
                        //----------------------------------------------
                        // Function to Right bar toggle
                        //----------------------------------------------
                        document.getElementById('toggleButton').addEventListener('click', function() {
                            const chatMembers = document.querySelector('.chat-members');
                            const iconVisible = document.getElementById('icon-visible');
                            const iconHidden = document.getElementById('icon-hidden');
                            const isVisible = this.getAttribute('data-visible') === 'true';
                        
                            if (isVisible) {
                                chatMembers.classList.add('hidden');
                                iconVisible.style.display = 'none';
                                iconHidden.style.display = 'block';
                                this.setAttribute('data-visible', 'false');
                            } else {
                                chatMembers.classList.remove('hidden');
                                iconVisible.style.display = 'block';
                                iconHidden.style.display = 'none';
                                this.setAttribute('data-visible', 'true');
                            }
                        });
                        
                        
                        //----------------------------------------------
                        // Function to toggle chat rooms
                        //----------------------------------------------
                        document.getElementById('chatRoomsToggle').addEventListener('click', function() {
                            const chatRooms = document.querySelector('.chat-rooms');
                            const iconVisible = document.getElementById('icon-visible');
                            const iconHidden = document.getElementById('icon-hidden');
                            
                            chatRooms.classList.toggle('collapsed');
                            
                            if (chatRooms.classList.contains('collapsed')) {
                                iconVisible.style.display = 'none';
                                iconHidden.style.display = 'block';
                            } else {
                                iconVisible.style.display = 'block';
                                iconHidden.style.display = 'none';
                            }
                        });
                        

                             //----------------------------------------------

                           // Function to make links clickable and embed YouTube videos
                        function linkify(inputText) {
                            var replacedText, replacePattern1, replacePattern2, replacePattern3;

                            //URLs starting with http://, https://, or ftp://
                            replacePattern1 = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
                            replacedText = inputText.replace(replacePattern1, '<a href="$1" target="_blank">$1</a>');

                            //URLs starting with "www." (without // before it, or it'd re-link the ones done above).
                            replacePattern2 = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
                            replacedText = replacedText.replace(replacePattern2, '$1<a href="http://$2" target="_blank">$2</a>');

                            //Change email addresses to mailto:: links.
                            replacePattern3 = /(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim;
                            replacedText = replacedText.replace(replacePattern3, '<a href="mailto:$1">$1</a>');

                            // Embed YouTube videos
                            const youtubePattern = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/g;
                            replacedText = replacedText.replace(youtubePattern, '<iframe width="560" height="315" src="https://www.youtube.com/embed/$1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>');

                            return replacedText;
}
                        
                        var username = "{{ request.user.username }}";  // Ensure the user is authenticated to access username
                        console.log('Username:', username); // Debugging output

        });
        
    </script>

    
    <script>
          // Ensure the room links and display element are selected correctly
          const roomLinks = document.querySelectorAll('.channel-link');
          const roomNameDisplay = document.querySelector('.chat-title-room');

         // console.log('Room links found:', roomLinks.length); // Debugging output
         // console.log('Room name display element:', roomNameDisplay); // Debugging output

          roomLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault(); // Prevent default link action
               // console.log('Room link clicked'); // Check if this logs when you click a room link
                const roomName = this.getAttribute('data-room');
               // console.log('Room clicked:', roomName); // This should show the room name in the console
                roomNameDisplay.textContent = '🌠・' + roomName; // Update the room name display
            });
        });
        


        function toggleEmojiPicker() {
            var picker = document.getElementById('emoji-picker');
            picker.style.display = picker.style.display === 'flex' ? 'none' : 'flex';
            if (picker.style.display === 'flex') {
                loadEmojis(); // Ensure this is called to populate the picker
            }
        }
        
        
        function loadEmojis() {
            var picker = document.getElementById('emoji-picker');
            picker.innerHTML = ''; // Clear previous emojis if any
            // Define emojis
            var emojis = ['😀', '😂', '🤬', '😊', '😍', '💩', '👍', '📈', '📉', '🚀', '💸', '✅', '👻', '💰', '🌍', '❤️', '🎉', '🎂'];
            emojis.forEach(function(emoji) {
                var span = document.createElement('span');
                span.textContent = emoji;
                span.className = 'emoji-span';  // Set the class name for the span
                span.onclick = function() { insertEmoji(emoji); };
                picker.appendChild(span);
            });
        }
        
        
        
        function insertEmoji(emoji) {
            // Adjust selector to target the textarea for chat messages
            var input = document.querySelector('.chat-message-input'); // Assuming this is the class for your chat message textarea
            input.value += emoji; // Append emoji to the textarea content
            input.focus(); // Optionally set focus back to the textarea
            // Uncomment the next line if you want to send the message immediately after inserting an emoji
          // document.querySelector('.chat-message-submit').click();
        }
        

        

        document.getElementById('toggleGifPicker').addEventListener('click', function() {
            var picker = document.getElementById('gif-picker');
            picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
            if (picker.style.display === 'block') {
                loadGifs(); // Load GIFs when the picker is displayed
            }
        });
        
        function loadGifs() {
            var apiKey = 'HnBk0eOngtbCc6S7u9Xt1vOXiaxf59VU';
            var url = `https://api.giphy.com/v1/gifs/trending?api_key=${apiKey}&limit=10`;
        
            fetch(url)
                .then(response => response.json())
                .then(content => {
                    var picker = document.getElementById('gif-picker');
                    picker.innerHTML = ''; // Clear existing GIFs if any
                    content.data.forEach((gif) => {
                        var img = document.createElement('img');
                        img.src = gif.images.fixed_height.url;
                        img.style.width = '100%';
                        img.onclick = () => insertGif(gif.images.fixed_height.url);
                        picker.appendChild(img);
                    });
                })
                .catch(err => {
                    console.error('Error fetching trending GIFs:', err);
                });
        }
        
        function insertGif(gifUrl) {
            var displayContainer = document.querySelector('.selected-gifs-container');
            var img = document.createElement('img');
            img.src = gifUrl;
            img.alt = "Selected GIF";
            img.style.maxWidth = "100px"; // Thumbnail size
            img.style.marginRight = "5px";
            displayContainer.appendChild(img);
        
            // Optional: Append the URL to the textarea for reference
            // var input = document.getElementById('userInput');
            // input.value += ` [GIF: ${gifUrl}] `; // This appends a reference, not the image itself
        }
        
        
        
            
    </script>
    <script type="text/javascript">
        var STATIC_URL = "{% static '' %}";
    </script>

{% endblock scripts %}